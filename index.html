<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>שערי מטבע - דולר ואירו</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      direction: rtl;
      background-color: #f4f6f8;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 20px 10px;
    }
    h1 {
      margin: 0;
    }
    .rates {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .rate-box {
      background-color: #ffffff;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      font-size: 1.5em;
      min-width: 200px;
    }
    .charts {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    canvas {
      margin: 40px 0;
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    #refresh-btn {
      background-color: #007acc;
      color: white;
      border: none;
      padding: 10px 25px;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 0;
    }
    #refresh-btn:hover {
      background-color: #005fa3;
    }
    .last-updated {
      font-size: 0.9em;
      color: #555;
      margin-bottom: 10px;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <header>
    <h1>שערי מטבע</h1>
  </header>

  <div class="rates">
    <div class="rate-box" id="usd-rate">טוען שער דולר...</div>
    <div class="rate-box" id="eur-rate">טוען שער אירו...</div>
  </div>

  <div class="last-updated" id="last-updated">...</div>
  <button id="refresh-btn">רענון נתונים</button>

  <div class="charts">
    <canvas id="usdChart"></canvas>
    <canvas id="eurChart"></canvas>
  </div>

  <script>
    let usdChartInstance = null;
    let eurChartInstance = null;

    function getFormattedDate(offsetDays = 0) {
      const d = new Date();
      d.setDate(d.getDate() - offsetDays);
      return d.toISOString().split("T")[0];
    }

    async function fetchRate(fromCurrency) {
      const res = await fetch(`https://api.frankfurter.app/latest?from=${fromCurrency}&to=ILS`);
      if (!res.ok) throw new Error("API fetch failed");
      return res.json();
    }

    async function fetchCurrentRates() {
      try {
        const [usdData, eurData] = await Promise.all([
          fetchRate("USD"),
          fetchRate("EUR")
        ]);

        const usdRate = usdData.rates.ILS;
        const eurRate = eurData.rates.ILS;

        document.getElementById("usd-rate").textContent = `1 דולר = ${usdRate.toFixed(3)} ₪`;
        document.getElementById("eur-rate").textContent = `1 אירו = ${eurRate.toFixed(3)} ₪`;

        const updateDate = usdData.date;
        document.getElementById("last-updated").textContent = `עודכן לאחרונה: ${updateDate.split('-').reverse().join('.')}`;
      } catch (err) {
        console.error("שגיאה בטעינת שערים:", err);
        document.getElementById("usd-rate").innerHTML = `<span class="error">שגיאה בשער דולר</span>`;
        document.getElementById("eur-rate").innerHTML = `<span class="error">שגיאה בשער אירו</span>`;
        document.getElementById("last-updated").textContent = '';
      }
    }

    async function fetchHistoricalRates(fromCurrency) {
      const endDate = getFormattedDate(0);
      const startDate = getFormattedDate(30);
      const url = `https://api.frankfurter.app/${startDate}..${endDate}?from=${fromCurrency}&to=ILS`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        const labels = Object.keys(data.rates).sort();
        const rates = labels.map(date => data.rates[date]["ILS"]);

        return { labels, rates };
      } catch (err) {
        console.error(`שגיאה בטעינת נתוני ${fromCurrency}:`, err);
        return { labels: [], rates: [] };
      }
    }

    async function drawChart(canvasId, currencyName, currencyCode, chartInstanceVar) {
      const data = await fetchHistoricalRates(currencyCode);

      if (chartInstanceVar && chartInstanceVar.destroy) {
        chartInstanceVar.destroy();
      }

      return new Chart(document.getElementById(canvasId), {
        type: "line",
        data: {
          labels: data.labels,
          datasets: [{
            label: `שער ${currencyName} (₪)`,
            data: data.rates,
            borderColor: currencyCode === "USD" ? "blue" : "green",
            borderWidth: 2,
            fill: false,
            tension: 0.2
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: value => value.toFixed(2) + " ₪"
              }
            }
          }
        }
      });
    }

    async function loadData() {
      await fetchCurrentRates();
      usdChartInstance = await drawChart("usdChart", "דולר", "USD", usdChartInstance);
      eurChartInstance = await drawChart("eurChart", "אירו", "EUR", eurChartInstance);
    }

    document.getElementById("refresh-btn").addEventListener("click", loadData);

    loadData(); // טעינה ראשונית
  </script>
</body>
</html>
